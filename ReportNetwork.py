from Network import Network
from Vulnerablity import Vulnerability
class ReportNetwork:
    def __init__(self, tenancy_name):
        self.report = dict()
        self.report["securityinternet"] = list()
        self.report["securityallprotocol"] = list()
        self.report["securityallports"] = list()
        self.report["securityport80"] = list()
        self.report["securityport7001"] = list()
        self.network = Network(tenancy_name)
        self.compartments = self.network.compartments
        self.initialize_report()

    def initialize_report(self):
        for compartment in self.compartments:
            for vcn in self.network.get_vcns(compartment.id):
                for subnet in self.network.get_subnets(compartment.id, vcn.id):
                    if subnet.prohibit_public_ip_on_vnic == 0:
                        for security_list in subnet.security_list_ids:
                            sls = self.network.get_security_list(security_list)
                            vulnerable = Vulnerability(sls)
                            if len(vulnerable.open_public_internet):
                                self.report['securityinternet'].append({
                                "sls_name" : sls.display_name,
                                "subnet_name" : subnet.display_name,
                                "no_of_rules" : str(len(vulnerable.open_public_internet)),
                                "vcn_name" : vcn.display_name,
                                "compartment_name" : compartment.name
                                })
                            if len(vulnerable.open_protocol):
                                self.report['securityallprotocol'].append({
                                "sls_name" : sls.display_name,
                                "subnet_name" : subnet.display_name,
                                "no_of_rules" : str(len(vulnerable.open_public_internet)),
                                "vcn_name" : vcn.display_name,
                                "compartment_name" : compartment.name
                                })
                            if len(vulnerable.open_port):
                                self.report['securityallports'].append({
                                "sls_name" : sls.display_name,
                                "subnet_name" : subnet.display_name,
                                "no_of_rules" : str(len(vulnerable.open_public_internet)),
                                "vcn_name" : vcn.display_name,
                                "compartment_name" : compartment.name
                                })
                            if len(vulnerable.open_port80):
                                self.report['securityport80'].append({
                                "sls_name" : sls.display_name,
                                "subnet_name" : subnet.display_name,
                                "no_of_rules" : str(len(vulnerable.open_public_internet)),
                                "vcn_name" : vcn.display_name,
                                "compartment_name" : compartment.name
                                })
                            if len(vulnerable.open_port7001):
                                self.report['securityport7001'].append({
                                "sls_name" : sls.display_name,
                                "subnet_name" : subnet.display_name,
                                "no_of_rules" : str(len(vulnerable.open_public_internet)),
                                "vcn_name" : vcn.display_name,
                                "compartment_name" : compartment.name
                                })
